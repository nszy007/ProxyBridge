name: Build ProxyBridge

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build for Windows ARM64
    runs-on: windows-latest-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup MSYS2 (for Clang ARM64)
      uses: msys2/setup-msys2@v2
      with:
        msystem: CLANGARM64
        update: true
        install: >-
          git
          make
          mingw-w64-clang-aarch64-toolchain

    - name: Add MSYS2 to PATH
      run: echo "C:\msys64\clangarm64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh

    - name: Install NSIS
      run: choco install nsis -y
      shell: pwsh

    - name: Build WinDivert from source for ARM64
      run: |
        git clone https://github.com/basil00/Divert.git --branch v2.2.2
        cd Divert/package/mingw
        make
        # Copy the built package to C:\ so the main build script can find it
        Copy-Item -Path "..\..\build\WinDivert-*" -Destination "C:\" -Recurse
      shell: pwsh

    - name: Verify WinDivert installation
      run: |
        $divertPath = (Get-ChildItem "C:\WinDivert-*-A").FullName
        if (Test-Path $divertPath) {
          Write-Host "WinDivert built and installed successfully at $divertPath"
          Get-ChildItem $divertPath -Recurse | Select-Object FullName
        } else {
          Write-Error "WinDivert installation failed"
          exit 1
        }
      shell: pwsh

    - name: Build project for ARM64
      run: .\compile.ps1 -NoSign -Arch arm64
      shell: pwsh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ProxyBridge-Build-arm64-${{ github.sha }}
        path: output/
        retention-days: 30

    - name: List output files
      run: |
        Write-Host "`nBuild artifacts:"
        Get-ChildItem output -Recurse | ForEach-Object {
          $size = [math]::Round($_.Length/1MB, 2)
          Write-Host "  $($_.Name) - $size MB"
        }
      shell: pwsh
