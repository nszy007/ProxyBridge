name: Build ProxyBridge ARM64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install Visual Studio Build Tools with ARM64 support
      run: |
        choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --quiet --norestart --nocache"
      shell: powershell

    - name: Build project using MSBuild targeting ARM64
      run: |
        $outputDir = "output\"
        if (-Not (Test-Path $outputDir)) { New-Item -ItemType Directory -Path $outputDir | Out-Null }
        msbuild ProxyBridge.csproj /p:Configuration=Release /p:Platform=ARM64 /p:OutDir=$outputDir
      shell: powershell

    - name: Install NSIS
      run: |
        choco install nsis -y
      shell: powershell

    - name: Download WinDivert
      run: |
        $url = "https://github.com/basil00/Divert/releases/download/v2.2.2/WinDivert-2.2.2-A.zip"
        Invoke-WebRequest -Uri $url -OutFile "WinDivert.zip"
        Expand-Archive -Path "WinDivert.zip" -DestinationPath "C:\"
      shell: powershell

    - name: Verify WinDivert installation
      run: |
        if (Test-Path "C:\WinDivert-2.2.2-A") {
          Write-Host "WinDivert installed successfully"
          Get-ChildItem "C:\WinDivert-2.2.2-A" -Recurse | Select-Object FullName
        } else {
          Write-Error "WinDivert installation failed"
          exit 1
        }
      shell: powershell

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ProxyBridge-ARM64-Build-${{ github.sha }}
        path: output/
        retention-days: 30

    - name: List output files
      run: |
        Write-Host "`nBuild artifacts:"
        Get-ChildItem output -Recurse | ForEach-Object {
          $size = [math]::Round($_.Length/1MB, 2)
          Write-Host "  $($_.Name) - $size MB"
        }
      shell: powershell
